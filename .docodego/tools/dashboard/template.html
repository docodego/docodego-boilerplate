<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DoCoDeGo Audit Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/gsap@3/dist/gsap.min.js"></script>
<style>
/* ── Theme — Linear-inspired neutral ──────────────── */
:root {
  --bg: #f7f7f7; --bg-card: #ffffff; --bg-inset: #ebebeb;
  --text: #1a1a1a; --text-muted: #737373; --border: #e0e0e0;
  --accent: #1a1a1a; --accent-text: #fff;
  --green: #dcfce7; --green-t: #166534;
  --yellow: #fef9c3; --yellow-t: #854d0e;
  --orange: #fed7aa; --orange-t: #9a3412;
  --red: #fecaca; --red-t: #991b1b;
  --radius: 6px; --shadow: 0 1px 2px rgba(0,0,0,.05);
}
@media(prefers-color-scheme:dark){:root{
  --bg:#121212; --bg-card:#1a1a1a; --bg-inset:#242424;
  --text:#cccccc; --text-muted:#737373; --border:#2a2a2a;
  --accent:#e0e0e0; --accent-text:#121212;
  --green:#166534; --green-t:#bbf7d0;
  --yellow:#854d0e; --yellow-t:#fef08a;
  --orange:#9a3412; --orange-t:#fed7aa;
  --red:#991b1b; --red-t:#fecaca;
  --shadow:0 1px 2px rgba(0,0,0,.4);
}}

/* ── Base ───────────────────────────────────────── */
*,*::before,*::after{box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;font-size:14px;
  color:var(--text);background:var(--bg);margin:0;padding:1.5rem;
  max-width:1280px;margin-inline:auto;line-height:1.5}
a{color:var(--text);text-decoration:none;font-weight:500}
a:hover{text-decoration:underline;color:var(--text-muted)}
h1{font-size:1.5rem;margin:0 0 .25rem}
h2{font-size:1.15rem;margin:1.25rem 0 .75rem;font-weight:600}
h3{font-size:1rem;margin:1rem 0 .5rem}
small{font-size:.8rem;color:var(--text-muted)}

/* ── Tabs ───────────────────────────────────────── */
.tabs{display:flex;gap:.25rem;margin:1.25rem 0 1rem;
  border-bottom:2px solid var(--border);padding-bottom:0}
.tab{padding:.45rem 1rem;border-radius:var(--radius) var(--radius) 0 0;
  cursor:pointer;font-size:.85rem;font-weight:500;
  color:var(--text-muted);border:1px solid transparent;
  border-bottom:none;background:none;transition:all .15s}
.tab:hover{color:var(--text);background:var(--bg-inset)}
.tab.active{color:var(--text);background:var(--bg-card);
  border-color:var(--border);margin-bottom:-2px;
  border-bottom:2px solid var(--bg-card);font-weight:600}
.panel{display:none}
.panel.active{display:block}

/* ── Cards ──────────────────────────────────────── */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:.75rem}
.card{background:var(--bg-card);border:1px solid var(--border);
  border-radius:var(--radius);padding:1rem;box-shadow:var(--shadow)}
.card h3{margin:0 0 .15rem;font-size:1.6rem;font-variant-numeric:tabular-nums}
.card p{margin:.15rem 0 0;color:var(--text-muted);font-size:.85rem}

/* ── Badges ─────────────────────────────────────── */
.badge{display:inline-block;padding:.15rem .5rem;border-radius:99px;
  font-size:.75rem;font-weight:600;line-height:1.3}
.badge-pass{background:var(--green);color:var(--green-t)}
.badge-fail{background:var(--red);color:var(--red-t)}
.badge-warn{background:var(--yellow);color:var(--yellow-t)}

/* ── Tool summary grid ──────────────────────────── */
.tool-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:.75rem}
.tool-card{display:flex;align-items:center;gap:.75rem;
  background:var(--bg-card);border:1px solid var(--border);
  border-radius:var(--radius);padding:.75rem 1rem;box-shadow:var(--shadow)}
.tool-score{font-size:1.4rem;font-weight:700;font-variant-numeric:tabular-nums;min-width:48px;text-align:center;
  padding:.3rem .5rem;border-radius:var(--radius)}
.tool-bar{flex:1;height:6px;border-radius:3px;background:var(--bg-inset);overflow:hidden}
.tool-fill{height:100%;border-radius:3px;transition:width .6s ease}

/* ── Heatmap ────────────────────────────────────── */
.hm-controls{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center;margin-bottom:.75rem}
.hm-controls input,.hm-controls select{padding:.35rem .5rem;
  border:1px solid var(--border);border-radius:var(--radius);
  background:var(--bg-card);color:var(--text);font-size:.82rem}
.hm-controls input{min-width:180px}
.hm{overflow:auto;max-height:75vh;border:1px solid var(--border);
  border-radius:var(--radius);background:var(--bg-card)}
.hm-head,.hm-row{display:flex}
.hm-head{position:sticky;top:0;z-index:3;background:var(--bg-card);
  border-bottom:2px solid var(--border);font-weight:600;font-size:.8rem}
.hm-name{flex:0 0 240px;position:sticky;left:0;z-index:2;
  background:var(--bg-card);padding:.35rem .6rem;
  border-right:2px solid var(--border);overflow:hidden;
  text-overflow:ellipsis;white-space:nowrap}
.hm-head .hm-name{z-index:4}
.hm-score{flex:1;min-width:68px;text-align:center;padding:.35rem .3rem;
  font-variant-numeric:tabular-nums;cursor:default;
  border-right:1px solid rgba(128,128,128,.08);transition:filter .15s}
.hm-score:hover{filter:brightness(.92)}
.hm-head .hm-score{cursor:pointer;user-select:none}
.hm-head .hm-score:hover{background:var(--bg-inset)}
.hm-head .hm-score .sort-arrow{font-size:.6rem;opacity:.4;margin-left:.2rem}
.hm-head .hm-score.sort-active .sort-arrow{opacity:1;color:var(--text)}
.hi{background:var(--green);color:var(--green-t)}
.md{background:var(--yellow);color:var(--yellow-t)}
.lo{background:var(--orange);color:var(--orange-t)}
.cr{background:var(--red);color:var(--red-t)}
.na{opacity:.3}
.hm-fail-mark{color:var(--red-t);font-size:.65rem;font-weight:700;margin-left:.15rem}
.hm-row .hm-name a{color:var(--text);text-decoration:none;font-size:.82rem}
.hm-row .hm-name a:hover{text-decoration:underline;color:var(--text-muted)}
.hm-group{display:flex;align-items:center;gap:.4rem;
  padding:.4rem .6rem;border-top:2px solid var(--border);
  cursor:pointer;font-size:.82rem;color:var(--text-muted);
  background:var(--bg-inset)}
.hm-group:hover{background:var(--border)}
.hm-group b{color:var(--text)}
.hm-chevron{font-size:.55rem;transition:transform .2s;display:inline-block}
.hm-group.collapsed .hm-chevron{transform:rotate(-90deg)}
.hm-hidden{display:none!important}
.hm-avg{font-weight:700}

/* ── Corpus cards ───────────────────────────────── */
.corpus-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:.75rem}
.dim-row{display:flex;align-items:center;gap:.5rem;margin:.35rem 0;font-size:.82rem}
.dim-label{flex:0 0 140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dim-bar{flex:1;height:8px;border-radius:4px;background:var(--bg-inset);overflow:hidden}
.dim-fill{height:100%;border-radius:4px}
.dim-val{flex:0 0 50px;text-align:right;font-variant-numeric:tabular-nums;font-weight:600}

/* ── Details ────────────────────────────────────── */
.detail-card{background:var(--bg-card);border:1px solid var(--border);
  border-radius:var(--radius);margin-bottom:.5rem;box-shadow:var(--shadow);overflow:hidden}
.detail-header{display:flex;align-items:center;gap:.5rem;padding:.6rem .8rem;
  cursor:pointer;font-size:.85rem}
.detail-header:hover{background:var(--bg-inset)}
.detail-chevron{font-size:.55rem;transition:transform .2s;color:var(--text-muted)}
.detail-card.open .detail-chevron{transform:rotate(90deg)}
.detail-name{font-weight:600;flex:1}
.detail-badges{display:flex;gap:.25rem;flex-wrap:wrap}
.detail-body{display:none;padding:.5rem .8rem .8rem;border-top:1px solid var(--border)}
.detail-card.open .detail-body{display:block}
.issue-list{margin:.3rem 0;padding-left:1.2rem;font-size:.8rem;color:var(--text-muted)}
.issue-list li{margin:.15rem 0}
.detail-group-header{font-weight:600;font-size:.9rem;margin:1rem 0 .4rem;
  padding-bottom:.25rem;border-bottom:1px solid var(--border);color:var(--text-muted)}
</style>
</head>
<body>
<div id="app"></div>
<script>
const DATA = /*__DATA__*/null;

/* ── Utilities ────────────────────────────────────── */
const {meta, specs, corpus, stats} = DATA || {};
const TOOLS = meta?.tools || {};
const ORDER = meta?.toolOrder || [];

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
function scoreClass(s, max = 100) {
  const p = s / max;
  return p >= .8 ? 'hi' : p >= .6 ? 'md' : p >= .4 ? 'lo' : 'cr';
}
function avg(arr) { return arr.length ? Math.round(arr.reduce((a,b) => a+b, 0) / arr.length) : 0; }
function specName(sp) { return (sp.spec || '').split('/').pop().replace('.md','').replace(/-/g,' ').replace(/\b\w/g, c => c.toUpperCase()); }
function specSlug(sp) { return (sp.spec || '').split('/').pop().replace('.md',''); }
function dimTitle(dims) {
  return Object.entries(dims||{}).map(([k,v]) =>
    `${k.replace(/_/g,' ')}: ${v.score}/${v.max_score}`).join(' | ');
}
function fillColor(s, max = 100) {
  const p = s / max;
  return p >= .8 ? 'var(--green-t)' : p >= .6 ? 'var(--yellow-t)' : p >= .4 ? 'var(--orange-t)' : 'var(--red-t)';
}

/* ── State ────────────────────────────────────────── */
let currentTab = 0;
let hmSortKey = 'name';
let hmSortAsc = true;
let hmAnimated = false;

/* ── Render: App ──────────────────────────────────── */
function renderApp() {
  if (!DATA) {
    document.getElementById('app').innerHTML =
      '<p>No data loaded. Run: <code>.docodego/tools/run dashboard &lt;audits-dir&gt;</code></p>';
    return;
  }
  const app = document.getElementById('app');
  const tabNames = ['Overview', 'Heatmap', 'Corpus', 'Details'];
  app.innerHTML = `
    <h1>DoCoDeGo Audit Dashboard</h1>
    <small>Generated ${new Date(meta.timestamp).toLocaleString(undefined, {dateStyle:'medium',timeStyle:'short'})} &mdash; ${stats.totalSpecs} specs, ${stats.totalCorpus} corpus audits</small>
    <div class="tabs">${tabNames.map((n, i) =>
      `<div class="tab${i === 0 ? ' active' : ''}" onclick="switchTab(${i})">${n}</div>`
    ).join('')}</div>
    <div class="panel active" id="p-overview"></div>
    <div class="panel" id="p-heatmap"></div>
    <div class="panel" id="p-corpus"></div>
    <div class="panel" id="p-details"></div>`;
  renderOverview();
  renderHeatmap();
  renderCorpus();
  renderDetails();
}

function switchTab(idx) {
  if (idx === currentTab) return;
  document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', i === idx));
  document.querySelectorAll('.panel').forEach((p, i) => {
    if (i === idx) { p.classList.add('active'); gsap.fromTo(p, {opacity:0,y:8}, {opacity:1,y:0,duration:.3,ease:'power2.out'}); }
    else p.classList.remove('active');
  });
  currentTab = idx;
  if (idx === 1 && !hmAnimated) { hmAnimated = true; animateHeatmapRows(); }
}

/* ── Render: Overview ─────────────────────────────── */
function renderOverview() {
  const totalP = Object.values(stats.toolPass).reduce((a,b) => a+b, 0);
  const totalF = Object.values(stats.toolFail).reduce((a,b) => a+b, 0);
  const total = totalP + totalF;
  const pct = total ? Math.round(totalP / total * 100) : 0;
  const groups = Object.entries(stats.groupCounts).sort().map(([k,v]) => `${v} ${k}`).join(', ');

  let html = `<div class="cards">
    <div class="card stat-card"><h3 data-count="${stats.totalSpecs}">0</h3><p>Specs Scored</p><small>${groups}</small></div>
    <div class="card stat-card"><h3 data-count="${stats.totalCorpus}">0</h3><p>Corpus Audits</p><small>${ORDER.filter(k => TOOLS[k]?.scope === 'corpus').map(k => k.toUpperCase()).join(', ')}</small></div>
    <div class="card stat-card"><h3 data-count="${stats.totalIssues}">0</h3><p>Issues Found</p><small>${stats.totalSuggestions} suggestions</small></div>
    <div class="card stat-card"><h3 data-count="${pct}">0</h3><p>Pass Rate %</p><small>${totalP} pass, ${totalF} fail</small></div>
  </div>`;

  html += '<h2>Tool Summary</h2><div class="tool-grid">';
  for (const tk of ORDER) {
    const scores = stats.toolScores[tk] || [];
    if (!scores.length) continue;
    const a = avg(scores);
    const p = stats.toolPass[tk];
    const f = stats.toolFail[tk];
    const cls = scoreClass(a);
    html += `<div class="tool-card">
      <div class="tool-score ${cls}">${a}</div>
      <div style="flex:1">
        <div style="font-weight:600;font-size:.85rem">${tk.toUpperCase()} <span style="font-weight:400;color:var(--text-muted)">${esc(TOOLS[tk]?.name || '')}</span></div>
        <div class="tool-bar"><div class="tool-fill" style="width:${a}%;background:${fillColor(a)}"></div></div>
        <div style="font-size:.75rem;color:var(--text-muted);margin-top:.2rem">${p} pass, ${f} fail &middot; ${TOOLS[tk]?.scope || ''}</div>
      </div>
    </div>`;
  }
  html += '</div>';

  document.getElementById('p-overview').innerHTML = html;
  gsap.from('.stat-card', {y:20, opacity:0, duration:.5, stagger:.1, ease:'power2.out'});
  gsap.from('.tool-card', {y:15, opacity:0, duration:.4, stagger:.06, ease:'power2.out', delay:.3});
  animateCounters();
}

function animateCounters() {
  document.querySelectorAll('[data-count]').forEach(el => {
    const target = parseInt(el.dataset.count);
    const obj = {val: 0};
    gsap.to(obj, {val: target, duration: 1.2, ease: 'power2.out',
      onUpdate: () => { el.textContent = Math.round(obj.val); }
    });
  });
}

/* ── Render: Heatmap ──────────────────────────────── */
function renderHeatmap() {
  const toolsPresent = ORDER.filter(tk => specs.some(s => s.tools?.[tk]));
  if (!toolsPresent.length) { document.getElementById('p-heatmap').innerHTML = '<p>No scores.</p>'; return; }

  // Group specs
  const groups = {};
  for (const sp of specs) { const g = sp._group || 'other'; (groups[g] = groups[g] || []).push(sp); }

  // Controls
  let html = `<div class="hm-controls">
    <input type="text" id="hm-search" placeholder="Search specs..." oninput="hmFilter()">
    <select id="hm-group" onchange="hmFilter()"><option value="">All groups</option>
      ${Object.keys(groups).sort().map(g => `<option value="${g}">${g}</option>`).join('')}
    </select>
    <select id="hm-status" onchange="hmFilter()">
      <option value="">All</option><option value="pass">Pass only</option><option value="fail">Has failures</option>
    </select>
  </div>`;

  // Heatmap grid
  html += '<div class="hm"><div class="hm-head">';
  html += '<div class="hm-name">Spec</div>';
  for (const tk of toolsPresent)
    html += `<div class="hm-score${hmSortKey===tk?' sort-active':''}" onclick="hmSort('${tk}')">${tk.toUpperCase()}<span class="sort-arrow">${hmSortKey===tk?(hmSortAsc?'&#9650;':'&#9660;'):'&#9650;'}</span></div>`;
  html += `<div class="hm-score${hmSortKey==='avg'?' sort-active':''}" onclick="hmSort('avg')">Avg<span class="sort-arrow">${hmSortKey==='avg'?(hmSortAsc?'&#9650;':'&#9660;'):'&#9650;'}</span></div>`;
  html += '</div><div id="hm-body">';

  for (const gn of Object.keys(groups).sort()) {
    const gSpecs = groups[gn].sort((a,b) => specName(a).localeCompare(specName(b)));
    const gAvgs = {};
    for (const tk of toolsPresent) {
      const sc = gSpecs.filter(s => s.tools?.[tk]).map(s => s.tools[tk].score);
      if (sc.length) gAvgs[tk] = avg(sc);
    }
    const allAvgs = Object.values(gAvgs);
    const gTotal = allAvgs.length ? avg(allAvgs) : 0;

    html += `<div class="hm-group" data-group="${esc(gn)}" onclick="hmToggleGroup(this)">
      <span class="hm-chevron">&#9660;</span> <b>${esc(gn)}</b> (${gSpecs.length})
      <span style="margin-left:auto;font-variant-numeric:tabular-nums">avg ${gTotal}</span></div>`;

    for (const sp of gSpecs) {
      const spAvgArr = toolsPresent.filter(tk => sp.tools?.[tk]).map(tk => sp.tools[tk].score);
      const spAvg = avg(spAvgArr);
      const hasFail = toolsPresent.some(tk => sp.tools?.[tk] && !sp.tools[tk].passed);
      const slug = specSlug(sp);
      const dataAttrs = toolsPresent.map(tk => `data-${tk}="${sp.tools?.[tk]?.score ?? -1}"`).join(' ');

      html += `<div class="hm-row" data-group="${esc(gn)}" data-name="${esc(specName(sp).toLowerCase())}" data-avg="${spAvg}" data-fail="${hasFail?1:0}" ${dataAttrs}>`;
      html += `<div class="hm-name"><a href="#d-${slug}">${esc(specName(sp))}</a></div>`;
      for (const tk of toolsPresent) {
        const tv = sp.tools?.[tk];
        if (tv) {
          const cls = scoreClass(tv.score);
          const fail = tv.passed ? '' : '<span class="hm-fail-mark">&#x2716;</span>';
          html += `<div class="hm-score ${cls}" title="${esc(dimTitle(tv.dimensions))}">${tv.score}${fail}</div>`;
        } else {
          html += '<div class="hm-score na">&mdash;</div>';
        }
      }
      html += `<div class="hm-score hm-avg ${scoreClass(spAvg)}">${spAvg}</div>`;
      html += '</div>';
    }
  }
  html += '</div></div>';
  document.getElementById('p-heatmap').innerHTML = html;
}

function hmToggleGroup(el) {
  el.classList.toggle('collapsed');
  const gn = el.dataset.group;
  const hidden = el.classList.contains('collapsed');
  document.querySelectorAll(`.hm-row[data-group="${gn}"]`).forEach(r =>
    r.classList.toggle('hm-hidden', hidden));
}

function hmFilter() {
  const q = (document.getElementById('hm-search').value || '').toLowerCase();
  const g = document.getElementById('hm-group').value;
  const s = document.getElementById('hm-status').value;
  document.querySelectorAll('.hm-row').forEach(r => {
    const mq = !q || r.dataset.name.includes(q);
    const mg = !g || r.dataset.group === g;
    const ms = !s || (s==='fail' && r.dataset.fail==='1') || (s==='pass' && r.dataset.fail==='0');
    r.classList.toggle('hm-hidden', !(mq && mg && ms));
  });
  document.querySelectorAll('.hm-group').forEach(gr => {
    const gn = gr.dataset.group;
    const any = document.querySelector(`.hm-row[data-group="${gn}"]:not(.hm-hidden)`);
    gr.classList.toggle('hm-hidden', !any);
  });
}

function hmSort(key) {
  if (key === hmSortKey) hmSortAsc = !hmSortAsc;
  else { hmSortKey = key; hmSortAsc = key === 'name'; }

  const body = document.getElementById('hm-body');
  const groups = {};
  body.querySelectorAll('.hm-group').forEach(gr => { groups[gr.dataset.group] = {header:gr, rows:[]}; });
  body.querySelectorAll('.hm-row').forEach(r => { const g = r.dataset.group; if(groups[g]) groups[g].rows.push(r); });

  for (const g of Object.values(groups)) {
    g.rows.sort((a,b) => {
      if (key === 'name') {
        const va = a.dataset.name||'', vb = b.dataset.name||'';
        return hmSortAsc ? va.localeCompare(vb) : vb.localeCompare(va);
      }
      const va = parseFloat(a.dataset[key]??-1), vb = parseFloat(b.dataset[key]??-1);
      return hmSortAsc ? va-vb : vb-va;
    });
  }

  for (const gn of Object.keys(groups).sort()) {
    const g = groups[gn];
    body.appendChild(g.header);
    g.rows.forEach(r => body.appendChild(r));
  }

  // Update header indicators
  document.querySelectorAll('.hm-head .hm-score').forEach(col => {
    const colKey = col.onclick?.toString().match(/'(\w+)'/)?.[1];
    col.classList.toggle('sort-active', colKey === key);
    const arrow = col.querySelector('.sort-arrow');
    if (arrow && colKey === key) arrow.innerHTML = hmSortAsc ? '&#9650;' : '&#9660;';
  });

  animateHeatmapRows();
}

function animateHeatmapRows() {
  gsap.from('.hm-row:not(.hm-hidden)', {opacity:0, x:-8, duration:.3, stagger:.008, ease:'power2.out'});
}

/* ── Render: Corpus ───────────────────────────────── */
function renderCorpus() {
  if (!corpus?.length) { document.getElementById('p-corpus').innerHTML = '<p>No corpus audits.</p>'; return; }
  let html = '<p style="color:var(--text-muted);font-size:.85rem">Directory-level scorers analyze the spec corpus as a whole.</p>';
  html += '<div class="corpus-grid">';

  for (const sp of corpus) {
    const grp = sp._group || 'unknown';
    for (const [tk, tv] of Object.entries(sp.tools || {})) {
      const info = TOOLS[tk] || {name: tk.toUpperCase()};
      const cls = scoreClass(tv.score);
      html += `<div class="card corpus-card">
        <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem">
          <span class="badge badge-${tv.passed?'pass':'fail'}">${tv.passed?'PASS':'FAIL'}</span>
          <b>${esc(info.name)}</b>
          <span class="badge" style="background:var(--border);color:var(--text)">${esc(grp)}</span>
          <span style="margin-left:auto;font-size:.85rem;font-weight:700;text-align:center;padding:.15rem .4rem;border-radius:var(--radius);white-space:nowrap" class="${cls}">${tv.score}/100</span>
        </div>`;

      for (const [dk, dv] of Object.entries(tv.dimensions || {})) {
        const dCls = scoreClass(dv.score, dv.max_score);
        const pct = Math.round(dv.score / dv.max_score * 100);
        html += `<div class="dim-row">
          <div class="dim-label">${esc(dk.replace(/_/g,' '))}</div>
          <div class="dim-bar"><div class="dim-fill ${dCls}" style="width:${pct}%"></div></div>
          <div class="dim-val">${dv.score}/${dv.max_score}</div>
        </div>`;
      }

      const issues = Object.values(tv.dimensions||{}).flatMap(d => d.issues||[]);
      if (issues.length) {
        html += `<details style="margin-top:.5rem;font-size:.82rem"><summary style="cursor:pointer;color:var(--text-muted)">${issues.length} issue(s)</summary>
          <ul class="issue-list">${issues.map(i => `<li>${esc(i)}</li>`).join('')}</ul></details>`;
      }
      html += '</div>';
    }
  }
  html += '</div>';
  document.getElementById('p-corpus').innerHTML = html;
  gsap.from('.corpus-card', {y:15, opacity:0, duration:.4, stagger:.1, ease:'power2.out'});
}

/* ── Render: Details ──────────────────────────────── */
function renderDetails() {
  const groups = {};
  for (const sp of specs) { const g = sp._group||'other'; (groups[g]=groups[g]||[]).push(sp); }

  let html = `<div class="hm-controls">
    <input type="text" id="detail-search" placeholder="Search specs..." oninput="detailFilter()">
    <select id="detail-group" onchange="detailFilter()"><option value="">All groups</option>
      ${Object.keys(groups).sort().map(g => `<option value="${g}">${g}</option>`).join('')}
    </select>
    <select id="detail-status" onchange="detailFilter()">
      <option value="">All</option><option value="pass">Pass only</option><option value="fail">Has failures</option>
    </select>
  </div><div id="detail-list">`;

  for (const gn of Object.keys(groups).sort()) {
    const gSpecs = groups[gn].sort((a,b) => specName(a).localeCompare(specName(b)));
    html += `<div class="detail-group-header">${esc(gn)} (${gSpecs.length})</div>`;

    for (const sp of gSpecs) {
      const slug = specSlug(sp);
      const hasFail = Object.values(sp.tools||{}).some(tv => !tv.passed);

      // Header badges
      let badges = '';
      for (const tk of ORDER) {
        const tv = sp.tools?.[tk];
        if (tv) {
          const cls = scoreClass(tv.score);
          badges += `<span class="badge" style="background:var(--${cls === 'hi'?'green':cls === 'md'?'yellow':cls === 'lo'?'orange':'red'});color:var(--${cls === 'hi'?'green':cls === 'md'?'yellow':cls === 'lo'?'orange':'red'}-t)">${tk.toUpperCase()} ${tv.score}</span> `;
        }
      }

      html += `<div class="detail-card" id="d-${slug}" data-group="${esc(gn)}" data-name="${esc(specName(sp).toLowerCase())}" data-fail="${hasFail?1:0}">
        <div class="detail-header" onclick="this.parentElement.classList.toggle('open')">
          <span class="detail-chevron">&#9654;</span>
          <span class="detail-name">${esc(specName(sp))}</span>
          <div class="detail-badges">${badges}</div>
        </div>
        <div class="detail-body">
          <small style="color:var(--text-muted)">${esc(sp.spec||'')}</small>`;

      for (const tk of ORDER) {
        const tv = sp.tools?.[tk];
        if (!tv) continue;
        const info = TOOLS[tk] || {name: tk};
        html += `<h3>${tk.toUpperCase()} &mdash; ${tv.score}/100 <span class="badge badge-${tv.passed?'pass':'fail'}">${tv.passed?'PASS':'FAIL'}</span></h3>`;
        if (tv.status) html += `<small style="color:var(--text-muted)">${esc(tv.status)}</small>`;

        for (const [dk, dv] of Object.entries(tv.dimensions || {})) {
          const dCls = scoreClass(dv.score, dv.max_score);
          const pct = Math.round(dv.score / dv.max_score * 100);
          html += `<div class="dim-row">
            <div class="dim-label">${esc(dk.replace(/_/g,' '))}</div>
            <div class="dim-bar"><div class="dim-fill ${dCls}" style="width:${pct}%"></div></div>
            <div class="dim-val">${dv.score}/${dv.max_score}</div>
          </div>`;
        }

        const allIssues = Object.entries(tv.dimensions||{}).flatMap(([dk,dv]) => (dv.issues||[]).map(i => `<li><b>${esc(dk.replace(/_/g,' '))}:</b> ${esc(i)}</li>`));
        const allSugs = Object.entries(tv.dimensions||{}).flatMap(([dk,dv]) => (dv.suggestions||[]).map(i => `<li><b>${esc(dk.replace(/_/g,' '))}:</b> ${esc(i)}</li>`));
        if (allIssues.length) html += `<details><summary style="font-size:.82rem;cursor:pointer;color:var(--text-muted)">${allIssues.length} issue(s)</summary><ul class="issue-list">${allIssues.join('')}</ul></details>`;
        if (allSugs.length) html += `<details><summary style="font-size:.82rem;cursor:pointer;color:var(--text-muted)">${allSugs.length} suggestion(s)</summary><ul class="issue-list">${allSugs.join('')}</ul></details>`;
      }
      html += '</div></div>';
    }
  }
  html += '</div>';
  document.getElementById('p-details').innerHTML = html;
}

function detailFilter() {
  const q = (document.getElementById('detail-search').value||'').toLowerCase();
  const g = document.getElementById('detail-group').value;
  const s = document.getElementById('detail-status').value;
  document.querySelectorAll('.detail-card').forEach(c => {
    const mq = !q || c.dataset.name.includes(q);
    const mg = !g || c.dataset.group === g;
    const ms = !s || (s==='fail'&&c.dataset.fail==='1') || (s==='pass'&&c.dataset.fail==='0');
    c.style.display = (mq && mg && ms) ? '' : 'none';
  });
  document.querySelectorAll('.detail-group-header').forEach(h => {
    let next = h.nextElementSibling;
    let any = false;
    while (next && !next.classList.contains('detail-group-header')) {
      if (next.classList.contains('detail-card') && next.style.display !== 'none') any = true;
      next = next.nextElementSibling;
    }
    h.style.display = any ? '' : 'none';
  });
}

/* ── Init ─────────────────────────────────────────── */
document.addEventListener('DOMContentLoaded', renderApp);
</script>
</body>
</html>
